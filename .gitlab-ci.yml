build:
    image: docker:latest
    stage: build
    services:
        - docker:dind
    before_script:
        - export KITSU_VERSION=0.10.10
        - export BASE_NAME=${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/kitsu
        - export IMAGE_NAME=${BASE_NAME}:${KITSU_VERSION}
        - export BUILD_NAME=${IMAGE_NAME}-layered
        - apk add --update py-pip && pip install docker-squash
        - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    script:
        - docker build --build-arg KITSU_VERSION=${KITSU_VERSION} --pull -t "${BUILD_NAME}" .
        - docker-squash -t "${IMAGE_NAME}" "${BUILD_NAME}"
        - docker tag "${IMAGE_NAME}" "${BASE_NAME}:latest"
        - docker push "${BASE_NAME}"
    only:
        - kitsu
